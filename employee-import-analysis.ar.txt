تحليل واجهة استيراد بيانات الموظفين وإصدار استمارات مطابقة (تطبيق سطح مكتب بايثون)
التاريخ: 2025-12-14

1) الهدف
- بناء تطبيق سطح مكتب (Windows) لاستيراد بيانات الموظفين من ملفات CSV/Excel، ثم إصدار “استمارة مطابقة للبيانات” لكل موظف بصيغة PDF قابلة للطباعة.
- واجهات عربية بالكامل مع دعم اتجاه RTL.

2) نطاق العمل (Scope)
ضمن النطاق:
- شاشة استيراد ملف (CSV و/أو XLSX) من الجهاز.
- معاينة البيانات قبل الحفظ.
- مطابقة/تعيين الأعمدة إلى حقول الموظف.
- التحقق من صحة البيانات وتقرير أخطاء على مستوى الصف.
- حفظ البيانات محليًا في قاعدة SQLite.
- شاشة قائمة الموظفين.
- توليد استمارة PDF عربية RTL لكل موظف أو تصدير مجموعة.
- سجل عمليات بسيط (من قام بالاستيراد/متى/عدد السجلات/عدد المرفوض).

خارج النطاق (في الإصدار الأول ما لم يُطلب خلاف ذلك):
- تكامل مع نظام حضور/رواتب خارجي.
- حسابات مستخدمين وصلاحيات متقدمة.
- مزامنة شبكية/خادم مركزي.
- تصميم استمارات متعددة النماذج/القوالب.

3) التقنية المقترحة ولماذا
- Python 3.11+
- PySide6 (Qt): مناسبة للجداول (Preview)، حوارات الملفات، ودعم الطباعة إلى PDF.
- pandas: لقراءة CSV وتهيئة البيانات بسرعة.
- openpyxl: لقراءة XLSX عبر pandas.
- SQLite: تخزين محلي بسيط دون إعدادات.
- Jinja2: لتوليد HTML لقالب الاستمارة.

4) متطلبات الواجهة (Arabic UI / RTL)
- جميع النصوص عربية: العناوين، الأزرار، الرسائل، رسائل الأخطاء.
- تفعيل RTL على مستوى التطبيق (layoutDirection = RightToLeft).
- محاذاة الجداول والنصوص RTL.
- دعم النص العربي في PDF: استخدام خط عربي وتضمينه/تحميله داخل Qt لضمان الطباعة الصحيحة.

5) حالات الاستخدام (Use Cases)
UC-1: استيراد ملف موظفين
- المستخدم يضغط “استيراد”.
- يختار ملف CSV أو Excel.
- تظهر معاينة أول N صف.
- يحدد المستخدم مطابقة الأعمدة (مثلاً: عمود “الاسم” -> Full Name).
- التطبيق يتحقق من البيانات ويعرض تقرير أخطاء.
- المستخدم يضغط “اعتماد الاستيراد” للحفظ في SQLite.

UC-2: إصدار استمارة لموظف
- المستخدم يفتح “الموظفون”.
- يحدد موظفًا.
- يضغط “طباعة/تصدير PDF”.
- التطبيق يولد PDF من قالب عربي ويخزّنه في مسار يختاره المستخدم.

UC-3: إصدار استمارات دفعة
- المستخدم يحدد مجموعة أو “تصدير الكل”.
- التطبيق يولد ملف PDF لكل موظف (أو PDF واحد متعدد الصفحات حسب قرار التنفيذ).

6) نموذج البيانات (Data Model)
مقترح للحقول الأساسية (قابل للتعديل حسب احتياج الجهة):
- employee_code (إلزامي، فريد)
- full_name (إلزامي)
- national_id (اختياري، يفضّل فريد إن توفر)
- department (اختياري)
- job_title (اختياري)
- hire_date (اختياري)
- phone (اختياري)
- email (اختياري)
- notes (اختياري)

مقترح التخزين في SQLite:
- جدول employees
  - id INTEGER PK
  - employee_code TEXT UNIQUE NOT NULL
  - full_name TEXT NOT NULL
  - data_json TEXT (JSON لباقي الحقول المرنة)
  - created_at TEXT
  - updated_at TEXT

السبب: يسمح بتوسعة الحقول دون كسر المخطط بسرعة، مع الحفاظ على مفاتيح البحث الأساسية.

7) صيغ الاستيراد ودعم العربية
CSV:
- الافتراضي UTF-8.
- توفير خيار ترميز: UTF-8 / Windows-1256 (شائع للملفات العربية).
- التعامل مع الفواصل: comma أو semicolon عند الحاجة.

Excel (XLSX):
- القراءة عبر pandas + openpyxl.
- اختيار ورقة (sheet) إذا كان الملف يحتوي عدة أوراق (يمكن إضافة ذلك لاحقًا).

8) مطابقة الأعمدة (Column Mapping)
- بعد التحميل: التطبيق يعرض قائمة أعمدة الملف.
- المستخدم يختار لكل حقل مطلوب (employee_code, full_name) عمودًا مطابقًا.
- الحقول الاختيارية يمكن مطابقتها أو تجاهلها.

حقلان إلزاميان في الإصدار الأول:
- رقم الموظف (employee_code)
- الاسم الكامل (full_name)

9) قواعد التحقق (Validation Rules)
- employee_code: غير فارغ، بعد إزالة المسافات، لا يتكرر داخل الملف ولا داخل قاعدة البيانات.
- full_name: غير فارغ، طول معقول (مثلاً 2..200).
- national_id (إن استُخدم): أرقام فقط أو تنسيق معروف، وطول متوقع.
- hire_date: قابل للتحويل إلى تاريخ عند وجوده.
- email: صيغة بريد صحيحة عند وجوده.

نتيجة التحقق:
- تقرير صفّي يحتوي: رقم الصف، سبب الرفض، والقيم المشكلة.
- يسمح بالحفظ الجزئي: حفظ الصفوف الصحيحة ورفض الخاطئة (مع تقرير واضح).

10) تدفق الاستيراد (Flow)
1) اختيار ملف
2) قراءة إلى DataFrame
3) معاينة + إظهار عدد الصفوف والأعمدة
4) شاشة مطابقة الأعمدة
5) مرحلة التحقق:
   - تطبيع القيم (trim، توحيد أرقام، معالجة تواريخ)
   - اكتشاف التكرار
   - تجميع الأخطاء
6) اعتماد الاستيراد:
   - Insert/Update حسب السياسة
   - كتابة سجل عملية

سياسة التحديث المقترحة (قابلة للتغيير):
- إذا employee_code موجود: تحديث full_name وباقي البيانات.
- وإلا: إدراج جديد.

11) الاستمارة (Form) وتوليد PDF
- الاستمارة تُولد من قالب HTML عربي RTL (Jinja2).
- عناصر القالب:
  - عنوان الجهة (قابل للتعديل)
  - “استمارة بيانات موظف”
  - جدول حقول (اسم الحقل/القيمة)
  - مساحة توقيع/ختم
  - تاريخ الطباعة

توليد PDF:
- استخدام Qt printing (QTextDocument + QPrinter) لضمان طباعة محلية دون خدمات خارجية.
- تضمين خط عربي لضمان سلامة الحروف والاتجاه.

12) معايير القبول (Acceptance Criteria)
- التطبيق يفتح بواجهة عربية RTL.
- يمكن استيراد CSV عربي (UTF-8 وWindows-1256) وعرضه في جدول.
- يمكن للمستخدم مطابقة الأعمدة الأساسية وحفظ البيانات في SQLite.
- تظهر أخطاء الصفوف بوضوح ولا تمنع حفظ الصفوف السليمة.
- يمكن توليد PDF عربي صحيح الحروف والاتجاه لموظف واحد على الأقل.

13) المخاطر والافتراضات
- جودة ملفات الإدخال قد تكون غير ثابتة (ترميزات مختلفة، أعمدة بأسماء متنوعة).
- طباعة العربية في PDF تتطلب خطًا عربيًا متاحًا/مضمّنًا.
- عدم وجود نموذج استمارة رسمي: سيتم اعتماد قالب افتراضي قابل للتعديل.

14) أسئلة مفتوحة (لتحسين الدقة)
- ما الحقول النهائية المطلوب دعمها؟
- هل تريد الأرقام 123 أم ١٢٣ في الواجهة وPDF؟
- هل التصدير يكون PDF لكل موظف أم ملف واحد متعدد الصفحات؟
- هل سياسة التحديث عند التكرار: تحديث أم رفض أم إنشاء نسخة؟

15) تقسيم التنفيذ (Milestones)
M1: هيكل المشروع + نافذة رئيسية عربية RTL.
M2: استيراد CSV + معاينة + مطابقة + تحقق.
M3: SQLite حفظ/تحديث + سجل عمليات.
M4: قائمة موظفين + توليد PDF عربي RTL.
M5: تحسينات (XLSX، خيارات ترميز، تصدير دفعات، إعدادات القالب).

16) تصميم الواجهات (UX) بشكل أدق
مبدأ عام:
- شاشات قليلة وواضحة، مع خطوات متتابعة للاستيراد (Wizard) لتقليل الأخطاء.
- لا يتم حفظ أي شيء قبل مرحلة “اعتماد الاستيراد”.

الواجهة 1: الشاشة الرئيسية
- شريط علوي باسم التطبيق.
- تبويبات/أزرار تنقّل رئيسية (الحد الأدنى):
  1) الاستيراد
  2) الموظفون
  3) الاستمارات
  4) الإعدادات (اختياري لكنه مفيد لضبط عنوان الجهة والشعار ومسار الحفظ)

الواجهة 2: شاشة “الاستيراد” (3 خطوات)
الخطوة A: اختيار الملف
- زر: “اختيار ملف…”
- نص يوضح الصيغ المدعومة.
- خيار “ترميز CSV”: UTF-8 / Windows-1256.
- خيار “فاصل CSV”: تلقائي/،/؛ (إن لزم).

الخطوة B: المعاينة
- عرض أول 50-200 صف في جدول.
- إظهار: عدد الصفوف، عدد الأعمدة، أسماء الأعمدة.
- زر: “التالي: مطابقة الأعمدة”.

الخطوة C: مطابقة الأعمدة والتحقق
- قائمة منسدلة لكل حقل مطلوب لاختيار عمود الملف.
- زر: “تحقق”.
- عند التحقق: عرض ملخص (صحيح/مرفوض/مكرر) + جدول أخطاء.
- زر: “اعتماد الاستيراد” (يُفعّل عند وجود صفوف صالحة).
- بعد الاعتماد: رسالة نجاح + زر “فتح قائمة الموظفين”.

الواجهة 3: شاشة “الموظفون”
- جدول بالحد الأدنى: رقم الموظف، الاسم، القسم (إن وُجد).
- مربع بحث بسيط (بالرقم أو الاسم) (اختياري ويمكن تأجيله).
- أزرار: “عرض/تعديل”، “حذف” (الحذف اختياري ويمكن جعله “تعطيل/أرشفة” لاحقًا).

الواجهة 4: شاشة “الاستمارات”
- اختيار موظف/مجموعة.
- زر: “تصدير PDF لموظف” أو “تصدير PDF للكل”.
- اختيار مجلد حفظ.
- تقرير بعد التصدير: عدد الملفات المولدة + أي أخطاء.

17) قاموس الحقول (Data Dictionary) المقترح
ملاحظة: الحقول قابلة للتعديل، لكن يفضّل تثبيت “الحد الأدنى” لتكون مطابقة الأعمدة مستقرة.

الحد الأدنى (MVP):
- employee_code (اسم عربي: رقم الموظف) | نوع: نص | إلزامي | فريد
- full_name (اسم عربي: الاسم الكامل) | نوع: نص | إلزامي

حقول شائعة:
- national_id (الهوية/رقم السجل) | نص/أرقام | اختياري | فريد إن توفر
- department (القسم) | نص | اختياري
- job_title (المسمى الوظيفي) | نص | اختياري
- hire_date (تاريخ التعيين) | تاريخ | اختياري
- phone (رقم الجوال) | نص | اختياري
- email (البريد الإلكتروني) | نص | اختياري
- notes (ملاحظات) | نص | اختياري

18) التطبيع (Normalization) للبيانات العربية
الهدف: تقليل اختلافات الإدخال التي تسبب تكرارًا أو فشل مطابقة.

قواعد عامة لكل القيم النصية:
- إزالة المسافات الزائدة من البداية/النهاية.
- تحويل المسافات المتعددة إلى مسافة واحدة.
- إزالة حرف التطويل (ـ) إن وُجد.
- تطبيع بعض أشكال الحروف (اختياري ومفضّل للأسماء فقط):
  - “أ/إ/آ” -> “ا”
  - “ى” -> “ي”
  - “ة” تبقى “ة” (عدم تحويلها إلى “ه” لتفادي تغيير المعنى)

تطبيع الأرقام:
- تحويل الأرقام العربية-الهندية ٠١٢٣٤٥٦٧٨٩ إلى 0123456789 في الحقول الرقمية (الهوية/الجوال) وأيضًا في employee_code إن كان رقميًا.

تطبيع رقم الجوال/الهاتف:
- إزالة المسافات والشرطات.
- الإبقاء على علامة + إن كانت موجودة في البداية.

تطبيع البريد الإلكتروني:
- تحويل إلى lowercase.
- إزالة المسافات.

19) نموذج الأخطاء (Error Model) وتقرير التحقق
المطلوب ليس فقط “فشل/نجاح”، بل سبب واضح يساعد المستخدم على تصحيح الملف.

مقترح هيكل خطأ لكل صف:
- row_number: رقم الصف في الملف (1-based كما يراه المستخدم)
- field: اسم الحقل الداخلي (مثلاً employee_code)
- column: اسم عمود الملف (إن أمكن)
- error_code: رمز ثابت (مثلاً REQUIRED, DUPLICATE_IN_FILE, DUPLICATE_IN_DB, INVALID_DATE)
- message_ar: رسالة عربية مختصرة
- value: القيمة المسببة (عند الإمكان)

أمثلة رسائل عربية:
- REQUIRED: “القيمة مطلوبة ولا يمكن أن تكون فارغة.”
- DUPLICATE_IN_FILE: “رقم الموظف مكرر داخل الملف.”
- DUPLICATE_IN_DB: “رقم الموظف موجود مسبقًا في قاعدة البيانات.”
- INVALID_DATE: “صيغة التاريخ غير صحيحة.”

سياسة التعامل:
- عرض “أخطاء حرجة” تمنع حفظ هذا الصف.
- يمكن عرض “تحذيرات” (مثل بريد غير موجود) بدون منع الحفظ.

20) سياسة التكرار والتحديث (Idempotency & Upsert)
الهدف: استيراد نفس الملف مرتين لا يسبب بيانات مكررة.

القاعدة الأساسية:
- مفتاح الهوية: employee_code.

سياسة افتراضية (مقترحة):
- إذا employee_code غير موجود في DB: إدراج جديد.
- إذا موجود: تحديث full_name وباقي الحقول التي تم توفيرها في الملف.

تفاصيل مهمة:
- تنفيذ العملية داخل Transaction لضمان الاتساق.
- تسجيل عدد الإدراجات والتحديثات والرفض.
- الحفاظ على created_at وعدم تغييره عند التحديث، وتحديث updated_at.

21) تصميم التخزين في SQLite بشكل عملي
جداول مقترحة:
1) employees
- id INTEGER PRIMARY KEY
- employee_code TEXT UNIQUE NOT NULL
- full_name TEXT NOT NULL
- data_json TEXT NOT NULL DEFAULT '{}'
- created_at TEXT NOT NULL
- updated_at TEXT NOT NULL

2) import_runs (سجل عمليات الاستيراد)
- id INTEGER PRIMARY KEY
- source_file TEXT
- started_at TEXT
- finished_at TEXT
- total_rows INTEGER
- inserted_count INTEGER
- updated_count INTEGER
- rejected_count INTEGER
- notes TEXT

3) import_run_errors (اختياري لتخزين الأخطاء)
- id INTEGER PRIMARY KEY
- import_run_id INTEGER
- row_number INTEGER
- field TEXT
- error_code TEXT
- message_ar TEXT

22) توليد PDF عربي RTL: تفاصيل تقنية مهمة
الحد الأدنى:
- قالب HTML RTL يستخدم CSS: direction: rtl; text-align: right;
- استخدام QTextDocument لعرض HTML.
- الطباعة عبر QPrinter إلى PDF.

نقاط حساسة بالعربية:
- يجب تثبيت/تحميل خط عربي داخل التطبيق (QFontDatabase) وتعيينه كخط افتراضي للـ QTextDocument.
- التأكد أن القالب لا يعتمد على خطوط غير متاحة.

خياران للإخراج:
- PDF لكل موظف (الأبسط والأكثر وضوحًا في الملفات).
- PDF واحد متعدد الصفحات (أكثر تعقيدًا؛ يمكن إضافته لاحقًا).

23) الأداء وتجربة المستخدم مع الملفات الكبيرة
مشاكل متوقعة:
- قراءة ملفات كبيرة (10k+ صف) قد تجمّد الواجهة إذا تمت على الـ UI thread.

حلول مقترحة:
- تنفيذ القراءة والتحقق في Thread/Worker وإرسال التقدم إلى الواجهة.
- في المعاينة: عرض أول N صف فقط، مع إظهار العدد الكلي.
- أثناء الحفظ: Batch commits (دفعات) بدل حفظ صف-صف بطيء.

24) السجلات (Logging) وسهولة الدعم
المطلوب:
- ملف سجل محلي (log) في مجلد التطبيق.
- تسجيل: أخطاء القراءة، أخطاء التحويل، الاستثناءات غير المتوقعة، وملخص import_runs.

ملاحظة خصوصية:
- عدم طباعة كامل بيانات الموظف في السجل إن كانت حساسة، والاكتفاء بمفاتيح مثل employee_code.

25) الأمن والخصوصية (ضمن تطبيق محلي)
تهديدات شائعة:
- ملفات CSV/Excel قد تحتوي بيانات حساسة.
- مشاركة قاعدة SQLite أو ملفات PDF دون قصد.

ممارسات مقترحة (حد أدنى):
- حفظ قاعدة البيانات في مجلد application data وليس بجانب exe إن أمكن.
- توفير زر “فتح مجلد البيانات” بدل كشف المسار بشكل عشوائي.
- خيار “تشفير قاعدة البيانات” يمكن إضافته لاحقًا (يتطلب مكتبة/نهج إضافي).

26) النسخ الاحتياطي والاسترجاع (اختياري لكنه عملي)
- زر “تصدير نسخة احتياطية” يقوم بنسخ ملف SQLite إلى مسار يحدده المستخدم.
- زر “استيراد نسخة احتياطية” (لاحقًا) لاستبدال قاعدة البيانات.

27) خطة اختبار (Testing) ومعايير نجاح أدق
اختبارات وحدات (Unit):
- parser: قراءة CSV بترميزات مختلفة.
- normalization: تحويل الأرقام العربية-الهندية.
- validator: التكرار، الحقول المطلوبة، تاريخ.
- repository: upsert وسلامة UNIQUE.

اختبارات يدوية (UI):
- ملف بسيط 5 صفوف بالعربية.
- ملف بترميز Windows-1256.
- ملف فيه تكرار employee_code داخل الملف.
- ملف فيه أسماء أعمدة مختلفة (مطابقة الأعمدة).
- توليد PDF ومراجعة اتجاه RTL وسلامة الحروف.

28) التغليف والنشر (Packaging) على Windows
هدف الإصدار:
- ملف تنفيذي واحد أو مجلد توزيع.

مقترح:
- PyInstaller لإنشاء exe.
- تضمين الخط العربي ضمن package.
- إنشاء مجلد data تلقائيًا عند التشغيل الأول.

29) قابلية التوسع لاحقًا
- إضافة حقول جديدة دون تغيير مخطط SQLite عبر data_json.
- إضافة “قوالب استمارة متعددة” لاحقًا (إن طُلب) عبر مجلد templates.
- دعم استيراد من أكثر من ورقة Excel أو اختيار Sheet.

30) قرارات افتراضية مقترحة (لتقليل الأسئلة)
- واجهة عربية RTL بالكامل.
- CSV مدعوم (UTF-8 وWindows-1256).
- XLSX مدعوم (ورقة واحدة افتراضيًا).
- مفتاح فريد: رقم الموظف.
- إخراج: PDF لكل موظف في مجلد يختاره المستخدم.
